# 3.2.1 Hardware Abstraction Layer
The basic Windows architecture is shown in the figure.![[win-architecture.png]]A hardware abstraction layer (HAL) is software that handles all of the communication between the hardware and the kernel. The kernel is the core of the operating system and has control over the entire computer. It handles all of the input and output requests, memory, and all of the peripherals connected to the computer.

In some instances, the kernel still communicates with the hardware directly, so it is not completely independent of the HAL. The HAL also needs the kernel to perform some functions.
# 3.2.2 User Mode and Kernel Mode
There are two different modes in which a CPU operates when the computer has Windows installed: the user mode and the kernel mode.
Installed applications run in user mode, and operating system code runs in kernel mode.

Code that is executing in kernel mode has unrestricted access to the underlying hardware and is capable of executing any CPU instruction.

Conversely, programs such as user applications, run in user mode and have no direct access to hardware or memory locations. User mode code must go through the operating system to access hardware resources.

All of the code that runs in kernel mode uses the same address space. Kernel-mode drivers have no isolation from the operating system.
# 3.2.3 Windows File System

| **Windows File System**                  | **Description**                                                                                                                                                                                                                                                                                                                                                                                                    |
| ---------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **exFAT**                                | - This is a simple file system supported by many different operating systems.<br>- FAT has limitations to the number of partitions, partition sizes, and file sizes that it can address, so it is not usually used for hard drives (HDs) or solid-state drives (SSDs) anymore.<br>- Both FAT16 and FAT32 are available to use, with FAT32 being the most common because it has many fewer restrictions than FAT16. |
| **Hierarchical File System Plus (HFS+)** | - This file system is used on MAC OS X computers and allows much longer filenames, file sizes, and partition sizes than previous file systems.<br>- Although it is not supported by Windows without special software, Windows is able to read data from HFS+ partitions.                                                                                                                                           |
| **Extended File System (EXT)**           | - This file system is used with Linux-based computers.<br>- Although it is not supported by Windows, Windows is able to read data from EXT partitions with special software.                                                                                                                                                                                                                                       |
| **New Technology File System (NTFS)**    | - This is the most commonly used file system when installing Windows. All versions of Windows and Linux support NTFS.<br>- Mac-OS X computers can only read an NTFS partition. They are able to write to an NTFS partition after installing special drivers.                                                                                                                                                       |
NTFS is also very reliable and supports recovery features. Most importantly, it supports many security features. Data access control is achieved through security descriptors. These security descriptors contain file ownership and permissions all the way down to the file level. NTFS also tracks many time stamps to track file activity. Sometimes referred to as MACE, the timestamps Modify, Access, Create, and Entry Modified are often used in forensic investigations to determine the history of a file or folder. NTFS also supports file system encryption to secure the entire storage media.
NTFS formatting creates important structures on the disk for file storage, and tables for recording the locations of files:

- **Partition Boot Sector** - This is the first 16 sectors of the drive. It contains the location of the Master File Table (MFT). The last 16 sectors contain a copy of the boot sector.
- **Master File Table (MFT)** - This table contains the locations of all the files and directories on the partition, including file attributes such as security information and timestamps.
- **System Files** - These are hidden files that store information about other volumes and file attributes.
- **File Area** - The main area of the partition where files and directories are stored.

# 3.2.4 Alternate Data Streams
NTFS stores files as a series of attributes, such as the name of the file, or a timestamp. The data which the file contains is stored in the attribute $DATA, and is known as a data stream. By using NTFS, you can connect Alternate Data Streams (ADSs) to the file. This is sometimes used by applications that are storing additional information about the file. The ADS is an important factor when discussing malware. This is because it is easy to hide data in an ADS. An attacker could store malicious code within an ADS that can then be called from a different file.
In the NTFS file system, a file with an ADS is identified after the filename and a colon, for example, **Testfile.txt:ADS**. This filename indicates an ADS called ADS is associated with the file called **Testfile.txt**.
# 3.2.5 Windows Boot Process
![[win-boot-proc.png]]
Two types of computer firmware exist:

- **Basic Input-Output System (BIOS)** - BIOS firmware was created in the early 1980s and works in the same way it did when it was created. As computers evolved, it became difficult for BIOS firmware to support all the new features requested by users.
- **Unified Extensible Firmware Interface (UEFI)** - UEFI was designed to replace BIOS and support the new features.
In BIOS firmware, the process begins with the BIOS initialization phase. This is when hardware devices are initialized and a power on self-test (POST) is performed to make sure all of these devices are communicating. When the system disk is discovered, the POST ends. The last instruction in the POST is to look for the master boot record (MBR).

The MBR contains a small program that is responsible for locating and loading the operating system. The BIOS executes this code and the operating system starts to load.

In contrast to BIOS firmware, UEFI firmware has a lot of visibility into the boot process. UEFI boots by loading EFI program files, stored as .efi files in a special disk partition, known as the EFI System Partition (ESP).

Whether the firmware is BIOS or UEFI, after a valid Windows installation is located, the **Bootmgr.exe** file is run. **Bootmgr.exe** switches the system from real mode to protected mode so that all of the system memory can be used.

**Bootmgr.exe** reads the Boot Configuration Database (BCD). The BCD contains any additional code needed to start the computer, along with an indication of whether the computer is coming out of hibernation, or if this is a cold start. If the computer is coming out of hibernation, the boot process continues with **Winresume.exe**. This allows the computer to read the **Hiberfil.sys** file which contains the state of the computer when it was put into hibernation.

If the computer is being booted from a cold start, then the **Winload.exe** file is loaded. The **Winload.exe** file creates a record of the hardware configuration in the registry. The registry is a record of all of the settings, options, hardware, and software the computer has. The registry will be explored in depth later in this chapter. **Winload.exe** also uses Kernel Mode Code Signing (KMCS) to make sure that all drivers are digitally signed. This ensures that the drivers are safe to load as the computer starts.

After the drivers have been examined, **Winload.exe** runs **Ntoskrnl.exe** which starts the Windows kernel and sets up the HAL. Finally, the Session Manager Subsystem (SMSS) reads the registry to create the user environment, start the Winlogon service, and prepare each userâ€™s desktop as they log on.
# 3.2.6 Windows Startup
There are two important registry items that are used to automatically start applications and services:

- **HKEY_LOCAL_MACHINE** - Several aspects of Windows configuration are stored in this key, including information about services that start with each boot.
- **HKEY_CURRENT_USER** - Several aspects related to the logged in user are stored in this key, including information about services that start only when the user logs on to the computer.
Different entries in these registry locations define which services and applications will start, as indicated by their entry type. These types include Run, RunOnce, RunServices, RunServicesOnce, and Userinit. These entries can be manually entered into the registry, but it is much safer to use the **Msconfig.exe** tool.
# 3.2.7 Windows Shutdown
- **Shutdown** - Turns the computer off (power off).
- **Restart** - Re-boots the computer (power off and power on).
- **Hibernate** - Records the current state of the computer and user environment and stores it in a file. Hibernation allows the user to pick up right where they left off very quickly with all their files and programs still open.
# 3.2.8 Processes, Threads, and Services
A process is any program that is currently executing. Each process that runs is made up of at least one thread. A thread is a part of the process that can be executed. The processor performs calculations on the thread. To configure Windows processes, search for Task Manager.
# 3.2.9 Memory Allocation and Handles
Each user space process runs in a private address space, separate from other user space processes. When the user space process needs to access kernel resources, it must use a process handle. This is because the user space process is not allowed to directly access these kernel resources. The process handle provides the access needed by the user space process without a direct connection to it.

A powerful tool for viewing memory allocation is RAMMap, which is shown in the figure. RAMMap is part of the Windows Sysinternals Suite of tools.
# 3.2.10 The Windows Registry
Windows stores all of the information about hardware, applications, users, and system settings in a large database known as the registry. The ways that these objects interact are also recorded, such as what files an application opens and all of the property details of folders and applications. The registry is a hierarchical database where the highest level is known as a hive, below that there are keys, followed by subkeys. Values store data and are stored in the keys and subkeys. A registry key can be up to 512 levels deep.

| Registry Hive                  | Description                                                                                                                                                                                          |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **HKEY_CURRENT_USER (HKCU)**   | Holds information concerning the currently logged in user.                                                                                                                                           |
| **HKEY_USERS (HKU)**           | Holds information concerning all the user accounts on the host.                                                                                                                                      |
| **HKEY_CLASSES_ROOT (HKCR)**   | Holds information about object linking and embedding (OLE) registrations. OLE allows users to embed objects from other applications like a spreadsheet) into single document (like a Word document.) |
| **HKEY_LOCAL_MACHINE (HKLM)**  | Holds system-related information.                                                                                                                                                                    |
| **HKEY_CURRENT_CONFIG (HKCC)** | Holds information about the current hardware profile.                                                                                                                                                |
Registry keys can contain either a subkey or a value. The different values that keys can contain are as follows:

- **REG_BINARY** - Numbers or Boolean values
- **REG_DWORD** - Numbers greater than 32 bits or raw data
- **REG_SZ** - String values